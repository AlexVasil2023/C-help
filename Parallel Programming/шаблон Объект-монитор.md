
[[#Объект-монитор|Объект-монитор]] 10.2
1. [[#Требования|Требования]] 10.2.1
2. [[#Компоненты|Компоненты]] 10.2.2
3. [[#Принцип действия монитора|Принцип действия монитора]] 10.2.3
	1. [[#Преимущества и недостатки мониторов|Преимущества и недостатки мониторов]] 10.2.3.1
	2. [[#Реализация монитора|Реализация монитора]] 10.2.3.2


# Объект-монитор

Идея шаблона «Монитор» состоит в синхронизации параллельного выполнения функций-членов объекта так, чтобы не более одной из них могло выполняться в каждый момент времени. Кроме того, данный шаблон позволяет строить последовательность выполнения функций-членов объекта для решения общей задачи. Этот шаблон известен также под названием «Потокобезопасный пассивный объект».

## Требования

Если несколько потоков одновременно имеют доступ к одному объекту, должны соблюдаться следующие ограничения.

4. Во избежание гонки данных находящийся в общем доступе объект должен быть защищён от несинхронизированных операций записи и чтения.
5. Необходимые для этого механизмы синхронизации должны составлять деталь реализации объекта, а не часть его интерфейса.
6. Когда какой-либо поток заканчивает работу с общим объектом, ожидающие потоки должны получать оповещение о том, что могут приступить к работе с объектом. Этот механизм позволяет избежать мёртвых блокировок и улучшает общую производительность системы.
7. После того как функция-член объекта отработает, истинность инвариантов общего объекта должна сохраняться.

Шаблон «Монитор» представляет собой решение всех четырёх задач. Поток-клиент может получить доступ к синхронизированным функциям-членам объекта-монитора – причём благодаря наличию блокировки только одна функция может выполняться в любой момент времени. Каждый объект-монитор содержит переменную условия, через которую происходит оповещение ожидающих клиентов.

## Компоненты

Объект-монитор состоит из четырёх компонентов, как показано на следующем рисунке.

![[ParallelProg_219.png]]

8. Собственно объект-монитор, который поддерживает одну или несколько функций-членов. Каждый клиент может обращаться к объекту только посредством этих функций. Вызванная функция выполняется в потоке клиента.
9. Синхронизированные функции-члены объекта-монитора. Механизм синхронизации гарантирует, что только одна из них может выполняться в любой заданный момент времени. Для этого хорошо подходит [[Управление изменяемым состоянием#Потокобезопасный интерфейс|шаблон «Потокобезопасный интерфейс»]], – он предписывает делать различие между интерфейсными функциями-членами и внутренними, составляющими детали реализации.
10. Блокировщик монитора. Каждый объект-монитор содержит один примитив блокировки, используемый для синхронизации интерфейсных функций.
11. Условия монитора, которые позволяют различным потокам согласовать между собой вызовы функций-членов монитора. Всякий раз, когда клиент заканчивает выполнение синхронизированной функции-члена, по условию пробуждается следующий клиент, ожидающий своего права вызвать функцию монитора.

Если блокировщик гарантирует исключительный доступ к монитору единственного клиента, то условие монитора сводит к минимуму время ожидания клиентов. Если блокировщик защищает монитор от гонки данных, то условия защищают от мёртвых блокировок.

## Принцип действия монитора

Взаимодействие между различными составными частями шаблона происходит в несколько этапов.

* Когда клиент вызывает синхронизированную функцию-член монитора, в первую очередь запирается блокировщик объекта. Если клиенту удалось захватить блокировку, выполняется вызванная функция, после чего снимается блокировка. Если же захват блокировки не удался, клиент блокируется.
* Заблокированный клиент ждёт оповещения от условия монитора. Оповещение происходит в момент освобождения монитора предыдущим клиентом. Оно может отсылаться одному взятому наугад ожидающему клиенту или всем таким клиентам. Ожидание условия обычно экономно расходует машинные ресурсы, в отличие от цикла активного ожидания.
* Когда клиент получает оповещение и пробуждается, он запирает блокировщик монитора и выполняет функцию. По окончании этого блокировка снимается и высылается оповещение, пробуждающее следующего клиента.

### Преимущества и недостатки мониторов

Мониторы обладают следующими преимуществами.

* Клиент не перегружен деталями синхронизации – они полностью скрыты в реализации монитора.
* Синхронизированные функции-члены по мере вызова автоматически выстраиваются в очередь. Механизм ожидания и оповещения, воплощённый в виде условия, работает как простой планировщик.

Данный шаблон не свободен также от ряда недостатков.

* Непросто бывает изменить механизм синхронизации, заложенный в функциях-членах монитора, поскольку полезная нагрузка функции и механизм синхронизации слишком жёстко связаны друг с другом.
* Если синхронизированная функция-член монитора вызывает, прямо или косвенно, функцию того же самого объекта-монитора, может произойти мёртвая блокировка.

### Реализация монитора






















